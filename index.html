<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Food Offers Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .calendar-view .calendar-container {
            max-width: 100%;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .setup-screen {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .setup-screen h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
        }

        .setup-screen p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            color: #999;
            margin-top: 5px;
            font-size: 12px;
        }

        .help-link {
            color: #667eea;
            text-decoration: none;
            font-size: 13px;
        }

        .help-link:hover {
            text-decoration: underline;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            margin-top: 10px;
        }

        .connect-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .connect-btn:active {
            transform: scale(0.95);
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            color: white;
            text-align: center;
            margin: 15px 0;
            font-size: 14px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .offer-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .offer-card:active {
            transform: scale(0.98);
            background: #e9ecef;
        }

        .offer-card.birthday {
            border-left-color: #ff6b6b;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe3e3 100%);
        }

        .offer-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .restaurant-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            flex: 1;
        }

        .expires-badge {
            background: #ff6b6b;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            margin-left: 10px;
        }

        .expires-badge.soon {
            background: #ff6b6b;
        }

        .expires-badge.medium {
            background: #ffa500;
        }

        .expires-badge.later {
            background: #51cf66;
        }

        .offer-preview {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .offer-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 0;
        }

        .offer-card.expanded .offer-details {
            max-height: 500px;
            margin-top: 15px;
        }

        .detail-row {
            display: flex;
            padding: 10px 0;
            border-top: 1px solid #dee2e6;
        }

        .detail-label {
            font-weight: bold;
            color: #495057;
            width: 80px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #333;
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .count-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }

        .settings-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .settings-btn:active {
            background: rgba(255,255,255,0.3);
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box p {
            color: #1565c0;
            margin: 0;
            font-size: 13px;
        }

        #appContent {
            display: none;
        }

        .hidden {
            display: none;
        }

        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .view-toggle-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-toggle-btn.active {
            background: #667eea;
            color: white;
        }

        .view-toggle-btn:active {
            transform: scale(0.95);
        }

        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .calendar-nav-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .calendar-nav-btn:active {
            transform: scale(0.9);
        }

        .calendar-month-year {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            width: 100%;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            color: #667eea;
            padding: 8px 2px;
            font-size: 11px;
        }

        .calendar-day {
            min-height: 70px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 4px;
            background: #fafafa;
            position: relative;
            overflow: hidden;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .calendar-day-number {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .calendar-offer-dot {
            width: 100%;
            background: #667eea;
            color: white;
            font-size: 8px;
            padding: 2px;
            border-radius: 3px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            line-height: 1.2;
        }

        .calendar-offer-dot.birthday {
            background: #ff6b6b;
        }

        .calendar-offer-dot:active {
            opacity: 0.8;
        }

        .calendar-offer-count {
            position: absolute;
            bottom: 3px;
            right: 3px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
        }

        .list-view {
            display: block;
        }

        .calendar-view {
            display: none;
        }

        .offers-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .offers-modal.active {
            display: flex;
        }

        .offers-modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            width: 100%;
        }

        .offers-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .offers-modal-close {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 600px) {
            .calendar-container {
                padding: 10px;
            }

            .calendar-month-year {
                font-size: 16px;
            }

            .calendar-nav-btn {
                width: 30px;
                height: 30px;
                font-size: 16px;
            }

            .calendar-grid {
                gap: 2px;
            }

            .calendar-day {
                min-height: 55px;
                padding: 3px 2px;
            }

            .calendar-day-header {
                font-size: 10px;
                padding: 5px 1px;
            }

            .calendar-offer-dot {
                font-size: 7px;
                padding: 1px 2px;
                margin-bottom: 1px;
            }

            .calendar-day-number {
                font-size: 10px;
                margin-bottom: 2px;
            }

            .calendar-offer-count {
                font-size: 8px;
                padding: 1px 4px;
                bottom: 2px;
                right: 2px;
            }
        }
        .offer-card.used {
            opacity: 0.5;
            position: relative;
        }

        .offer-card.used::after {
            content: '‚úì USED';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #51cf66;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .calendar-offer-dot.used {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .calendar-offer-dot.used::before {
            content: '‚úì ';
        }

        .mark-used-btn {
            background: #51cf66;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .mark-used-btn:active {
            transform: scale(0.95);
        }

        .mark-used-btn.marked {
            background: #868e96;
        }

        .dismiss-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .dismiss-btn:active {
            transform: scale(0.95);
        }

        .dismiss-btn.dismissed {
            background: #868e96;
        }

        .offer-card.dismissed {
            opacity: 0.5;
            background: #f1f3f5;
        }

        .archive-toggle {
            text-align: center;
            margin: 15px 0;
        }

        .archive-toggle label {
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .archive-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .section-subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçî Food Offers Tracker</h1>
            <p>Never miss a restaurant deal!</p>
        </header>

        <!-- Setup Screen -->
        <div id="setupScreen" class="setup-screen">
            <h2>üîê One-Time Setup</h2>
            <p>Enter your Google API credentials below. These will be stored securely in your browser only.</p>
            
            <div class="info-box">
                <p><strong>Need credentials?</strong> Follow the setup guide to get your free Google API Key and Client ID from Google Cloud Console.</p>
            </div>

            <div class="form-group">
                <label for="clientId">Google Client ID</label>
                <input type="text" id="clientId" placeholder="xxxxx.apps.googleusercontent.com">
                <small>Looks like: 123456789-abc.apps.googleusercontent.com</small>
            </div>

            <div class="form-group">
                <label for="apiKey">Google API Key</label>
                <input type="text" id="apiKey" placeholder="AIzaSy...">
                <small>Starts with: AIzaSy</small>
            </div>

            <button id="saveCredentials" class="btn">Save & Continue</button>
            
            <p style="margin-top: 20px; text-align: center;">
                <a href="#" class="help-link" onclick="alert('1. Go to console.cloud.google.com\n2. Create new project\n3. Enable Gmail API\n4. Create API Key\n5. Create OAuth Client ID\n\nSee the full setup guide for detailed instructions!'); return false;">üìñ How do I get these credentials?</a>
            </p>
        </div>

        <!-- Main App Content -->
        <div id="appContent">
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="connectBtn" class="connect-btn">Connect Gmail</button>
                <button id="settingsBtn" class="settings-btn">‚öôÔ∏è Change Credentials</button>
                <div id="status" class="status"></div>
            </div>

            <!-- View Toggle -->
            <div id="viewToggle" class="view-toggle" style="display: none;">
                <button id="listViewBtn" class="view-toggle-btn active">üìã List View</button>
                <button id="calendarViewBtn" class="view-toggle-btn">üìÖ Calendar View</button>
            </div>

            <!-- Archive Toggle -->
            <div id="archiveToggle" class="archive-toggle" style="display: none;">
                <label>
                    <input type="checkbox" id="showUsedOffers" checked>
                    Show used/archived offers
                </label>
                <br>
                <label style="margin-top: 10px; display: inline-flex;">
                    <input type="checkbox" id="showDismissedOffers">
                    Show dismissed offers
                </label>
                <br>
                <label style="margin-top: 10px; display: inline-flex;">
                    <input type="checkbox" id="autoScanToggle" checked>
                    Auto-scan on page load
                </label>
            </div>

            <!-- List View (Original) -->
            <div id="listView" class="list-view">
                <div id="birthdaySection" class="section" style="display: none;">
                    <div class="section-header">
                        <span class="section-icon">üéÇ</span>
                        <span class="section-title">Birthday Offers</span>
                        <span id="birthdayCount" class="count-badge">0</span>
                    </div>
                    <div id="birthdayOffers"></div>
                </div>

                <div id="regularSection" class="section" style="display: none;">
                    <div class="section-header">
                        <span class="section-icon">üçΩÔ∏è</span>
                        <span class="section-title">All Offers</span>
                        <span id="regularCount" class="count-badge">0</span>
                    </div>
                    <div id="regularOffers"></div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendarView" class="calendar-view">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button id="prevMonth" class="calendar-nav-btn">‚Äπ</button>
                        <div class="calendar-month-year" id="calendarMonthYear"></div>
                        <button id="nextMonth" class="calendar-nav-btn">‚Ä∫</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <button id="refreshBtn" class="refresh-btn" style="display: none;">üîÑ Refresh Offers</button>
            <button id="exportBtn" class="refresh-btn" style="display: none; background: #51cf66; margin-top: 10px;">üì• Export to CSV</button>
        </div>

        <!-- Offers Modal for Calendar -->
        <div id="offersModal" class="offers-modal">
            <div class="offers-modal-content">
                <div class="offers-modal-header">
                    <h3 id="modalDate"></h3>
                    <button class="offers-modal-close" id="closeModal">√ó</button>
                </div>
                <div id="modalOffers"></div>
            </div>
        </div>
    </div>

    <script>
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let CLIENT_ID = '';
        let API_KEY = '';

        // Check if credentials exist on load
        window.addEventListener('load', function() {
            const savedClientId = localStorage.getItem('gmail_client_id');
            const savedApiKey = localStorage.getItem('gmail_api_key');

            if (savedClientId && savedApiKey) {
                CLIENT_ID = savedClientId;
                API_KEY = savedApiKey;
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('appContent').style.display = 'block';
                initializeAPIs();
            }
        });

        // Save credentials
        document.getElementById('saveCredentials').addEventListener('click', function() {
            const clientId = document.getElementById('clientId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!clientId || !apiKey) {
                alert('Please enter both Client ID and API Key');
                return;
            }

            if (!clientId.includes('.apps.googleusercontent.com')) {
                alert('Client ID should look like: xxxxx.apps.googleusercontent.com');
                return;
            }

            if (!apiKey.startsWith('AIzaSy')) {
                alert('API Key should start with: AIzaSy');
                return;
            }

            // Save to localStorage
            localStorage.setItem('gmail_client_id', clientId);
            localStorage.setItem('gmail_api_key', apiKey);

            CLIENT_ID = clientId;
            API_KEY = apiKey;

            // Show main app
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('appContent').style.display = 'block';

            // Initialize APIs
            initializeAPIs();
        });

        // Settings button to change credentials
        document.getElementById('settingsBtn').addEventListener('click', function() {
            if (confirm('Do you want to change your API credentials? This will require you to re-enter them.')) {
                localStorage.removeItem('gmail_client_id');
                localStorage.removeItem('gmail_api_key');
                document.getElementById('appContent').style.display = 'none';
                document.getElementById('setupScreen').classList.remove('hidden');
                document.getElementById('clientId').value = '';
                document.getElementById('apiKey').value = '';
            }
        });

        function initializeAPIs() {
            // Load Google API
            const script1 = document.createElement('script');
            script1.src = 'https://apis.google.com/js/api.js';
            script1.onload = gapiLoaded;
            document.body.appendChild(script1);

            const script2 = document.createElement('script');
            script2.src = 'https://accounts.google.com/gsi/client';
            script2.onload = gisLoaded;
            document.body.appendChild(script2);
        }

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
            });
            gapiInited = true;
            maybeEnableAutoScan();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableAutoScan();
        }

        function maybeEnableAutoScan() {
            if (gapiInited && gisInited) {
                setTimeout(autoConnectAndScan, 500);
            }
        }

        document.getElementById('connectBtn').addEventListener('click', handleAuthClick);
        document.getElementById('refreshBtn').addEventListener('click', scanEmails);
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);

        let allOffersData = [];
        let currentCalendarDate = new Date();
        let showUsedOffers = true;
        let showDismissedOffers = false;
        let autoScanEnabled = true;
        let isScanning = false;

        // OAuth token management
        function saveAccessToken(accessToken) {
            const expiryTime = Date.now() + (3600 * 1000); // 1 hour from now
            localStorage.setItem('gmail_access_token', accessToken);
            localStorage.setItem('gmail_token_expiry', expiryTime.toString());
        }

        function getAccessToken() {
            const token = localStorage.getItem('gmail_access_token');
            const expiry = localStorage.getItem('gmail_token_expiry');
            
            if (token && expiry && Date.now() < parseInt(expiry)) {
                return token;
            }
            return null;
        }

        function clearAccessToken() {
            localStorage.removeItem('gmail_access_token');
            localStorage.removeItem('gmail_token_expiry');
        }

        // Auto-scan preference
        function isAutoScanEnabled() {
            const setting = localStorage.getItem('auto_scan_enabled');
            return setting === null || setting === 'true'; // Default to true
        }

        function setAutoScanEnabled(enabled) {
            localStorage.setItem('auto_scan_enabled', enabled ? 'true' : 'false');
            autoScanEnabled = enabled;
        }

        // Initialize auto-scan setting
        autoScanEnabled = isAutoScanEnabled();
        if (document.getElementById('autoScanToggle')) {
            document.getElementById('autoScanToggle').checked = autoScanEnabled;
        }

        // Used offers tracking
        function getUsedOffers() {
            const used = localStorage.getItem('used_offers');
            return used ? JSON.parse(used) : [];
        }

        function markOfferAsUsed(offerId) {
            const usedOffers = getUsedOffers();
            if (!usedOffers.includes(offerId)) {
                usedOffers.push(offerId);
                localStorage.setItem('used_offers', JSON.stringify(usedOffers));
            }
        }

        function unmarkOfferAsUsed(offerId) {
            let usedOffers = getUsedOffers();
            usedOffers = usedOffers.filter(id => id !== offerId);
            localStorage.setItem('used_offers', JSON.stringify(usedOffers));
        }

        function isOfferUsed(offerId) {
            return getUsedOffers().includes(offerId);
        }

        function getDismissedOffers() {
            const dismissed = localStorage.getItem('dismissed_offers');
            return dismissed ? JSON.parse(dismissed) : [];
        }

        function dismissOffer(offerId) {
            const dismissedOffers = getDismissedOffers();
            if (!dismissedOffers.includes(offerId)) {
                dismissedOffers.push(offerId);
                localStorage.setItem('dismissed_offers', JSON.stringify(dismissedOffers));
            }
        }

        function undismissOffer(offerId) {
            let dismissedOffers = getDismissedOffers();
            dismissedOffers = dismissedOffers.filter(id => id !== offerId);
            localStorage.setItem('dismissed_offers', JSON.stringify(dismissedOffers));
        }

        function isOfferDismissed(offerId) {
            return getDismissedOffers().includes(offerId);
        }

        function generateOfferId(offer) {
            // Create unique ID from restaurant + offer + expiration
            return `${offer.restaurant}-${offer.offer}-${offer.expiresDate.toISOString()}`.replace(/[^a-zA-Z0-9-]/g, '');
        }

        // View toggle
        document.getElementById('listViewBtn').addEventListener('click', function() {
            document.getElementById('listView').style.display = 'block';
            document.getElementById('calendarView').style.display = 'none';
            this.classList.add('active');
            document.getElementById('calendarViewBtn').classList.remove('active');
        });

        document.getElementById('calendarViewBtn').addEventListener('click', function() {
            document.getElementById('listView').style.display = 'none';
            document.getElementById('calendarView').style.display = 'block';
            this.classList.add('active');
            document.getElementById('listViewBtn').classList.remove('active');
            renderCalendar(currentCalendarDate);
        });

        // Calendar navigation
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar(currentCalendarDate);
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar(currentCalendarDate);
        });

        // Modal controls
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('offersModal').classList.remove('active');
        });

        document.getElementById('offersModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });

        // Show/hide used offers toggle
        document.getElementById('showUsedOffers').addEventListener('change', function() {
            showUsedOffers = this.checked;
            // Re-render current view
            const birthdayOffers = allOffersData.filter(o => o.isBirthday);
            const regularOffers = allOffersData.filter(o => !o.isBirthday);
            displayOffers(birthdayOffers, regularOffers);
            if (document.getElementById('calendarView').style.display !== 'none') {
                renderCalendar(currentCalendarDate);
            }
        });

        document.getElementById('showDismissedOffers').addEventListener('change', function() {
            showDismissedOffers = this.checked;
            // Re-render current view
            const birthdayOffers = allOffersData.filter(o => o.isBirthday);
            const regularOffers = allOffersData.filter(o => !o.isBirthday);
            displayOffers(birthdayOffers, regularOffers);
            if (document.getElementById('calendarView').style.display !== 'none') {
                renderCalendar(currentCalendarDate);
            }
        });

        // Auto-scan toggle
        document.getElementById('autoScanToggle').addEventListener('change', function() {
            setAutoScanEnabled(this.checked);
            if (this.checked) {
                document.getElementById('status').textContent = 'Auto-scan enabled - will load automatically next time';
            } else {
                document.getElementById('status').textContent = 'Auto-scan disabled - click Connect Gmail to load offers';
            }
        });

        function handleAuthClick() {
            if (!gapiInited || !gisInited) {
                alert('Please wait for Google APIs to load...');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    clearAccessToken();
                    throw (resp);
                }
                
                // Save access token
                if (resp.access_token) {
                    saveAccessToken(resp.access_token);
                }
                
                document.getElementById('status').textContent = 'Connected! Scanning emails...';
                document.getElementById('connectBtn').disabled = true;
                await scanEmails();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // Auto-connect and scan if we have valid credentials and tokens
        async function autoConnectAndScan() {
            if (!gapiInited || !gisInited) {
                return;
            }

            const savedToken = getAccessToken();
            if (savedToken && autoScanEnabled && !isScanning) {
                try {
                    // Set the token in gapi
                    gapi.client.setToken({access_token: savedToken});
                    
                    document.getElementById('status').textContent = 'Auto-loading your offers...';
                    document.getElementById('connectBtn').textContent = '‚úì Connected';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('connectBtn').style.opacity = '0.7';
                    
                    await scanEmails();
                } catch (error) {
                    console.error('Auto-scan failed:', error);
                    clearAccessToken();
                    document.getElementById('status').textContent = 'Click Connect Gmail to load offers';
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('connectBtn').textContent = 'Connect Gmail';
                    document.getElementById('connectBtn').style.opacity = '1';
                }
            }
        }

        async function scanEmails() {
            if (isScanning) {
                return; // Prevent duplicate scans
            }
            
            isScanning = true;
            
            try {
                document.getElementById('status').textContent = 'Scanning your emails...';
                
                // Search for food-related emails from the past year
                const queries = [
                    'subject:(offer OR deal OR coupon OR discount OR free) (restaurant OR food OR dining OR pizza OR burger OR cafe OR coffee)',
                    'birthday (restaurant OR dining OR food OR free)',
                    'from:(doordash OR ubereats OR grubhub OR restaurant OR dine)',
                    'reward points (restaurant OR food OR dining)'
                ];

                let allOffers = [];
                
                for (let query of queries) {
                    const response = await gapi.client.gmail.users.messages.list({
                        userId: 'me',
                        q: query,
                        maxResults: 50
                    });

                    if (response.result.messages) {
                        for (let message of response.result.messages) {
                            const details = await gapi.client.gmail.users.messages.get({
                                userId: 'me',
                                id: message.id,
                                format: 'full'
                            });
                            
                            const offer = parseEmailForOffer(details.result);
                            if (offer) {
                                allOffers.push(offer);
                            }
                        }
                    }
                }

                // Remove duplicates based on restaurant name and offer
                allOffers = removeDuplicates(allOffers);
                
                // Filter out offers expired by more than 30 days
                const now = new Date();
                const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                allOffers = allOffers.filter(offer => offer.expiresDate >= thirtyDaysAgo);
                
                // Add unique IDs and mark used status
                allOffers.forEach(offer => {
                    offer.id = generateOfferId(offer);
                    offer.isUsed = isOfferUsed(offer.id);
                    offer.isDismissed = isOfferDismissed(offer.id);
                });
                
                // Store globally for CSV export
                allOffersData = allOffers;
                
                // Separate birthday offers
                const birthdayOffers = allOffers.filter(o => o.isBirthday);
                const regularOffers = allOffers.filter(o => !o.isBirthday);

                // Sort by newest email date first (most recent at top)
                birthdayOffers.sort((a, b) => b.emailDate - a.emailDate);
                regularOffers.sort((a, b) => b.emailDate - a.emailDate);

                displayOffers(birthdayOffers, regularOffers);
                
                document.getElementById('status').textContent = `Found ${allOffers.length} offers!`;
                document.getElementById('refreshBtn').style.display = 'block';
                document.getElementById('exportBtn').style.display = 'block';
                document.getElementById('viewToggle').style.display = 'flex';
                document.getElementById('archiveToggle').style.display = 'block';
                
                // Reset calendar to current month
                currentCalendarDate = new Date();
                renderCalendar(currentCalendarDate);
                
            } catch (err) {
                console.error('Error:', err);
                
                // Check if it's an auth error
                if (err.status === 401 || err.status === 403) {
                    clearAccessToken();
                    document.getElementById('status').textContent = 'Session expired. Click Connect Gmail to reload.';
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('connectBtn').textContent = 'Connect Gmail';
                    document.getElementById('connectBtn').style.opacity = '1';
                } else {
                    document.getElementById('status').textContent = 'Error scanning emails. Please try again.';
                }
            } finally {
                isScanning = false;
            }
        }

        function cleanHtmlText(html) {
            // Remove HTML tags but keep the text
            let text = html.replace(/<style[^>]*>.*?<\/style>/gi, '');
            text = text.replace(/<script[^>]*>.*?<\/script>/gi, '');
            text = text.replace(/<[^>]+>/g, ' ');
            
            // Decode HTML entities
            text = text.replace(/&nbsp;/g, ' ');
            text = text.replace(/&amp;/g, '&');
            text = text.replace(/&lt;/g, '<');
            text = text.replace(/&gt;/g, '>');
            text = text.replace(/&quot;/g, '"');
            text = text.replace(/&#39;/g, "'");
            text = text.replace(/&rsquo;/g, "'");
            text = text.replace(/&lsquo;/g, "'");
            text = text.replace(/&rdquo;/g, '"');
            text = text.replace(/&ldquo;/g, '"');
            
            // Normalize whitespace
            text = text.replace(/\s+/g, ' ');
            text = text.trim();
            
            // Remove emojis and special Unicode characters that cause display issues
            // This removes most emojis, symbols, and other problematic characters
            text = text.replace(/[\u{1F600}-\u{1F64F}]/gu, ''); // Emoticons
            text = text.replace(/[\u{1F300}-\u{1F5FF}]/gu, ''); // Misc Symbols and Pictographs
            text = text.replace(/[\u{1F680}-\u{1F6FF}]/gu, ''); // Transport and Map
            text = text.replace(/[\u{1F1E0}-\u{1F1FF}]/gu, ''); // Flags
            text = text.replace(/[\u{2600}-\u{26FF}]/gu, '');   // Misc symbols
            text = text.replace(/[\u{2700}-\u{27BF}]/gu, '');   // Dingbats
            text = text.replace(/[\u{1F900}-\u{1F9FF}]/gu, ''); // Supplemental Symbols and Pictographs
            text = text.replace(/[\u{1FA00}-\u{1FA6F}]/gu, ''); // Chess Symbols
            text = text.replace(/[\u{1FA70}-\u{1FAFF}]/gu, ''); // Symbols and Pictographs Extended-A
            text = text.replace(/[\u{FE00}-\u{FE0F}]/gu, '');   // Variation Selectors
            text = text.replace(/[\u{200D}]/gu, '');            // Zero Width Joiner
            
            // Remove any remaining non-printable or problematic characters
            text = text.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
            
            // Clean up any double spaces created by emoji removal
            text = text.replace(/\s+/g, ' ').trim();
            
            return text;
        }

        function parseEmailForOffer(message) {
            try {
                const headers = message.payload.headers;
                const subject = headers.find(h => h.name === 'Subject')?.value || '';
                const from = headers.find(h => h.name === 'From')?.value || '';
                const date = new Date(parseInt(message.internalDate));
                
                // Validate date
                if (isNaN(date.getTime())) {
                    console.warn('Invalid email date for message:', message.id);
                    return null;
                }
                
                // Get email body - recursively extract from all parts
                let body = '';
                
                function extractBody(payload) {
                    if (payload.body && payload.body.data) {
                        try {
                            body += atob(payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
                        } catch (e) {
                            console.error('Error decoding body:', e);
                        }
                    }
                    
                    if (payload.parts) {
                        for (let part of payload.parts) {
                            // Handle text/plain and text/html
                            if (part.mimeType === 'text/plain' || part.mimeType === 'text/html') {
                                extractBody(part);
                            }
                            // Recursively check multipart
                            else if (part.mimeType && part.mimeType.startsWith('multipart/')) {
                                extractBody(part);
                            }
                        }
                    }
                }
                
                extractBody(message.payload);
                
                // Clean HTML from body
                body = cleanHtmlText(body);

                // Check if it's food-related
                const foodKeywords = ['restaurant', 'food', 'pizza', 'burger', 'coffee', 'dining', 'meal', 'cafe', 'eat', 'sushi', 'taco', 'sandwich', 'delivery', 'kitchen', 'grill', 'bistro', 'diner'];
                const offerKeywords = ['offer', 'deal', 'coupon', 'discount', 'free', 'off', '%', 'save', 'reward', 'promo', 'special', 'birthday'];
                
                const text = (subject + ' ' + body + ' ' + from).toLowerCase();
                
                const hasFood = foodKeywords.some(k => text.includes(k));
                const hasOffer = offerKeywords.some(k => text.includes(k));
                
                if (!hasFood || !hasOffer) return null;

                // Extract restaurant name
                const restaurant = extractRestaurantName(from, subject, body);
                
                // Validate restaurant name
                if (!restaurant || restaurant.length < 2) {
                    console.warn('Could not extract restaurant name from:', from);
                    return null;
                }
                
                // Check if birthday offer
                const isBirthday = /birthday|b-day|bday|born|celebration/i.test(text);
                
                // Extract offer details
                const offer = extractOfferDetails(subject, body);
                
                // Extract expiration date
                const expiresDate = extractExpirationDate(body, date);
                
                // Validate expiration date
                if (!expiresDate || isNaN(expiresDate.getTime())) {
                    console.warn('Invalid expiration date for:', restaurant);
                    return null;
                }
                
                // Extract location if available
                const location = extractLocation(body);

                return {
                    restaurant,
                    offer,
                    isBirthday,
                    expiresDate,
                    expiresText: formatExpiration(expiresDate),
                    location,
                    emailDate: date,
                    subject,
                    messageId: message.id
                };
            } catch (error) {
                console.error('Error parsing email:', error, message.id);
                return null;
            }
        }

        function extractRestaurantName(from, subject, body) {
            // Try to extract from "From" field first
            const fromMatch = from.match(/^([^<@]+)/);
            if (fromMatch) {
                let name = fromMatch[1].trim();
                
                // Clean up common email prefixes and suffixes
                name = name.replace(/^(info|no-reply|noreply|contact|support|team|hello|hi|news|marketing|offers|deals)\s*/i, '');
                name = name.replace(/\s+(info|no-reply|noreply|contact|support|team)$/i, '');
                
                // Remove common domain indicators
                name = name.replace(/\s*\|\s*.*/g, ''); // Remove "Name | Domain"
                name = name.replace(/\s*-\s*.*/g, ''); // Remove "Name - Something"
                
                // Clean up quotes and extra spaces
                name = name.replace(/["""]/g, '').trim();
                
                // Remove emojis and special characters
                name = name.replace(/[\u{1F600}-\u{1F64F}]/gu, '');
                name = name.replace(/[\u{1F300}-\u{1F5FF}]/gu, '');
                name = name.replace(/[\u{1F680}-\u{1F6FF}]/gu, '');
                name = name.replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '');
                name = name.replace(/[\u{2600}-\u{26FF}]/gu, '');
                name = name.replace(/[\u{2700}-\u{27BF}]/gu, '');
                name = name.replace(/[\u{1F900}-\u{1F9FF}]/gu, '');
                name = name.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                name = name.replace(/\s+/g, ' ').trim();
                
                if (name.length > 2 && name.length < 50) {
                    return name;
                }
            }
            
            // Try to find brand names in subject line
            const subjectBrandPatterns = [
                // "Your Chipotle Rewards" -> "Chipotle"
                /(?:your|from|at)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,2})\s+(?:reward|offer|deal|coupon)/i,
                // "Panda Express: Special Offer"
                /^([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,2})\s*[:|-]/i,
                // Just capitalized words at start
                /^([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,2})/
            ];
            
            for (let pattern of subjectBrandPatterns) {
                const match = subject.match(pattern);
                if (match && match[1]) {
                    const name = match[1].trim();
                    if (name.length > 2 && name.length < 50) {
                        return name;
                    }
                }
            }
            
            // Try to find restaurant/brand names in body (first 500 chars)
            const bodyStart = body.substring(0, 500);
            const bodyPatterns = [
                // "Welcome to Subway" or "Visit Subway"
                /(?:welcome to|visit|from|at)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,2})\s+(?:restaurant|cafe|kitchen|grill|eatery)/i,
                // Brand followed by location/restaurant keywords
                /\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,2})\s+(?:Restaurant|Cafe|Coffee|Kitchen|Grill|Bar|Pizzeria|Deli)/i
            ];
            
            for (let pattern of bodyPatterns) {
                const match = bodyStart.match(pattern);
                if (match && match[1]) {
                    const name = match[1].trim();
                    if (name.length > 2 && name.length < 50) {
                        return name;
                    }
                }
            }
            
            // Final fallback - use cleaned from field or generic
            if (fromMatch) {
                let name = fromMatch[1].trim();
                name = name.replace(/[^a-zA-Z0-9\s&'-]/g, '').trim();
                if (name.length > 2 && name.length < 50) {
                    return name;
                }
            }
            
            return 'Restaurant Offer';
        }

        function extractOfferDetails(subject, body) {
            // Look for specific offer patterns - check body first, then subject
            const text = body + ' ' + subject;
            
            const patterns = [
                // Percentage off
                /(\d+%\s+off[^.!?\n]{0,30})/i,
                // Dollar amount off
                /(\$\d+(?:\.\d{2})?\s+off[^.!?\n]{0,30})/i,
                // BOGO patterns
                /(buy\s+(?:one|1)\s+get\s+(?:one|1)(?:\s+free)?[^.!?\n]{0,30})/i,
                /(bogo[^.!?\n]{0,30})/i,
                // Free item patterns
                /(free\s+[a-z\s]{3,30}(?:with|when)[^.!?\n]{0,40})/i,
                /(complimentary\s+[a-z\s]{3,30})/i,
                // Get/Receive patterns
                /((?:get|receive)\s+(?:a\s+)?free\s+[a-z\s]{3,30})/i,
                // Reward/points patterns  
                /(\d+\s+(?:points|rewards)[^.!?\n]{0,30})/i,
                // Special/discount patterns
                /(special\s+(?:offer|deal|discount)[^.!?\n]{0,40})/i,
                // Free delivery
                /(free\s+(?:delivery|shipping)[^.!?\n]{0,30})/i,
                // Birthday specific
                /(birthday\s+(?:reward|freebie|gift|treat)[^.!?\n]{0,30})/i,
                // Coupon code patterns
                /((?:code|coupon):\s*[A-Z0-9]{4,15}[^.!?\n]{0,20})/i
            ];
            
            for (let pattern of patterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    let offer = match[1].trim();
                    
                    // Clean up the offer text
                    offer = offer.replace(/\s+/g, ' '); // Normalize spaces
                    offer = offer.replace(/\n/g, ' '); // Remove newlines
                    
                    // Remove emojis and special characters
                    offer = offer.replace(/[\u{1F600}-\u{1F64F}]/gu, '');
                    offer = offer.replace(/[\u{1F300}-\u{1F5FF}]/gu, '');
                    offer = offer.replace(/[\u{1F680}-\u{1F6FF}]/gu, '');
                    offer = offer.replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '');
                    offer = offer.replace(/[\u{2600}-\u{26FF}]/gu, '');
                    offer = offer.replace(/[\u{2700}-\u{27BF}]/gu, '');
                    offer = offer.replace(/[\u{1F900}-\u{1F9FF}]/gu, '');
                    offer = offer.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                    
                    // Clean up double spaces after emoji removal
                    offer = offer.replace(/\s+/g, ' ').trim();
                    
                    offer = offer.substring(0, 100); // Limit length
                    
                    // Capitalize first letter
                    offer = offer.charAt(0).toUpperCase() + offer.slice(1);
                    
                    return offer;
                }
            }
            
            // Fallback: look for offer-related sentences in subject
            if (subject.length > 10) {
                let cleanSubject = subject.trim();
                
                // Remove common prefixes
                cleanSubject = cleanSubject.replace(/^(re:|fwd:|fw:)\s*/i, '');
                
                // Remove emojis and special characters
                cleanSubject = cleanSubject.replace(/[\u{1F600}-\u{1F64F}]/gu, '');
                cleanSubject = cleanSubject.replace(/[\u{1F300}-\u{1F5FF}]/gu, '');
                cleanSubject = cleanSubject.replace(/[\u{1F680}-\u{1F6FF}]/gu, '');
                cleanSubject = cleanSubject.replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '');
                cleanSubject = cleanSubject.replace(/[\u{2600}-\u{26FF}]/gu, '');
                cleanSubject = cleanSubject.replace(/[\u{2700}-\u{27BF}]/gu, '');
                cleanSubject = cleanSubject.replace(/[\u{1F900}-\u{1F9FF}]/gu, '');
                cleanSubject = cleanSubject.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                cleanSubject = cleanSubject.replace(/\s+/g, ' ').trim();
                
                // If subject contains offer keywords, use it
                const offerKeywords = /offer|deal|coupon|discount|free|save|special|reward|birthday/i;
                if (offerKeywords.test(cleanSubject)) {
                    return cleanSubject.substring(0, 80);
                }
            }
            
            // Last resort: use subject (cleaned)
            let cleanedSubject = subject.replace(/[\u{1F600}-\u{1F64F}]/gu, '');
            cleanedSubject = cleanedSubject.replace(/[\u{1F300}-\u{1F5FF}]/gu, '');
            cleanedSubject = cleanedSubject.replace(/[\u{1F680}-\u{1F6FF}]/gu, '');
            cleanedSubject = cleanedSubject.replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '');
            cleanedSubject = cleanedSubject.replace(/[\u{2600}-\u{26FF}]/gu, '');
            cleanedSubject = cleanedSubject.replace(/[\u{2700}-\u{27BF}]/gu, '');
            cleanedSubject = cleanedSubject.replace(/[\u{1F900}-\u{1F9FF}]/gu, '');
            cleanedSubject = cleanedSubject.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
            cleanedSubject = cleanedSubject.replace(/\s+/g, ' ').trim();
            return cleanedSubject.substring(0, 60);
        }

        function extractExpirationDate(body, emailDate) {
            // Enhanced patterns to catch more date formats
            const patterns = [
                // "expires on January 15, 2025" or "expires January 15 2025"
                /expires?\s+(?:on\s+)?(\w+\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4})/i,
                // "valid until January 15, 2025"
                /valid\s+(?:until|through|thru)\s+(\w+\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4})/i,
                // "good until January 15, 2025"
                /good\s+(?:until|through|thru)\s+(\w+\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4})/i,
                // "offer ends January 15, 2025"
                /(?:offer|deal|promotion)\s+ends?\s+(\w+\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4})/i,
                // "redeem by January 15, 2025"
                /redeem\s+by\s+(\w+\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4})/i,
                // "01/15/2025" or "1/15/25"
                /(?:expires?|valid|good|ends?|redeem)[^\d]*(\d{1,2}\/\d{1,2}\/\d{2,4})/i,
                // "until 01/15/2025"
                /(?:until|through|thru|by)\s+(\d{1,2}\/\d{1,2}\/\d{2,4})/i,
                // "Jan 15, 2025" or "Jan 15 2025"
                /(\w{3,9}\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4})/i,
                // "2025-01-15" ISO format
                /(\d{4}-\d{2}-\d{2})/,
                // "15-Jan-2025" or "15 Jan 2025"
                /(\d{1,2}[-\s]\w{3,9}[-\s]\d{4})/i,
                // Just a date without context "January 15, 2025"
                /(\w{3,9}\s+\d{1,2},\s+\d{4})/i
            ];
            
            for (let pattern of patterns) {
                const match = body.match(pattern);
                if (match) {
                    let dateStr = match[1];
                    
                    // Try to parse the date
                    let parsed = new Date(dateStr);
                    
                    // If invalid, try cleaning up the string
                    if (isNaN(parsed.getTime())) {
                        // Remove ordinal suffixes (1st, 2nd, 3rd, 4th)
                        dateStr = dateStr.replace(/(\d+)(?:st|nd|rd|th)/gi, '$1');
                        parsed = new Date(dateStr);
                    }
                    
                    // Check if date is valid and in the future or reasonable past
                    if (!isNaN(parsed.getTime())) {
                        const now = new Date();
                        const twoYearsAgo = new Date(now.getFullYear() - 2, now.getMonth(), now.getDate());
                        const twoYearsFromNow = new Date(now.getFullYear() + 2, now.getMonth(), now.getDate());
                        
                        // Only accept dates within reasonable range
                        if (parsed >= twoYearsAgo && parsed <= twoYearsFromNow) {
                            return parsed;
                        }
                    }
                }
            }
            
            // Look for "expires in X days/weeks/months" patterns
            const relativePatterns = [
                /expires?\s+in\s+(\d+)\s+(day|days|week|weeks|month|months)/i,
                /valid\s+for\s+(\d+)\s+(day|days|week|weeks|month|months)/i,
                /good\s+for\s+(\d+)\s+(day|days|week|weeks|month|months)/i,
                /redeemable\s+for\s+(\d+)\s+(day|days|week|weeks|month|months)/i
            ];
            
            for (let pattern of relativePatterns) {
                const match = body.match(pattern);
                if (match) {
                    const amount = parseInt(match[1]);
                    const unit = match[2].toLowerCase();
                    
                    const expiryDate = new Date(emailDate);
                    if (unit.includes('day')) {
                        expiryDate.setDate(expiryDate.getDate() + amount);
                    } else if (unit.includes('week')) {
                        expiryDate.setDate(expiryDate.getDate() + (amount * 7));
                    } else if (unit.includes('month')) {
                        expiryDate.setMonth(expiryDate.getMonth() + amount);
                    }
                    return expiryDate;
                }
            }
            
            // Default: 30 days from email date
            const defaultExpiry = new Date(emailDate);
            defaultExpiry.setDate(defaultExpiry.getDate() + 30);
            return defaultExpiry;
        }

        function extractLocation(body) {
            // Look for location patterns in first 1000 characters
            const text = body.substring(0, 1000);
            
            const locationPatterns = [
                // "Location: 123 Main St"
                /(?:location|address|visit us|find us):\s*([^\n<]{10,100})/i,
                // "Store: 123 Main St"
                /store:\s*([^\n<]{10,100})/i,
                // "At: 123 Main St"
                /at:\s*(\d+[^\n<]{10,100})/i,
                // Street address patterns
                /(\d+\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,3}\s+(?:Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Drive|Dr|Lane|Ln|Way|Court|Ct))/i,
                // "Visit us at [location]"
                /visit\s+us\s+at\s+([^\n<.]{10,100})/i,
                // Locations page link
                /locations?\.(?:com|net|org)/i
            ];
            
            for (let pattern of locationPatterns) {
                const match = text.match(pattern);
                if (match) {
                    if (typeof match[1] === 'string') {
                        let location = match[1].trim();
                        
                        // Clean up HTML entities and tags
                        location = location.replace(/<[^>]+>/g, '');
                        location = location.replace(/&nbsp;/g, ' ');
                        location = location.replace(/&amp;/g, '&');
                        
                        // Remove extra whitespace
                        location = location.replace(/\s+/g, ' ');
                        
                        if (location.length > 10 && location.length < 200) {
                            return location;
                        }
                    } else {
                        // Found "locations.com" or similar - indicate online
                        return 'See website for locations';
                    }
                }
            }
            
            // Check if it mentions online/delivery only
            if (/online\s+only|delivery\s+only|mobile\s+app/i.test(text)) {
                return 'Online/App only';
            }
            
            return 'Check email for details';
        }

        function formatExpiration(date) {
            const now = new Date();
            const diff = date - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days < 0) return 'Expired';
            if (days === 0) return 'Today';
            if (days === 1) return 'Tomorrow';
            if (days < 7) return `${days} days`;
            if (days < 30) return `${Math.floor(days / 7)} weeks`;
            return date.toLocaleDateString();
        }

        function getExpiryClass(date) {
            const now = new Date();
            const diff = date - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days < 7) return 'soon';
            if (days < 30) return 'medium';
            return 'later';
        }

        function removeDuplicates(offers) {
            const seen = new Set();
            return offers.filter(offer => {
                const key = `${offer.restaurant}-${offer.offer}`.toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        function displayOffers(birthdayOffers, regularOffers) {
            const birthdaySection = document.getElementById('birthdaySection');
            const regularSection = document.getElementById('regularSection');
            const birthdayContainer = document.getElementById('birthdayOffers');
            const regularContainer = document.getElementById('regularOffers');
            
            // Filter based on showUsedOffers setting
            let displayBirthday = birthdayOffers;
            let displayRegular = regularOffers;
            
            if (!showUsedOffers) {
                displayBirthday = birthdayOffers.filter(o => !o.isUsed);
                displayRegular = regularOffers.filter(o => !o.isUsed);
            }
            
            if (!showDismissedOffers) {
                displayBirthday = displayBirthday.filter(o => !o.isDismissed);
                displayRegular = displayRegular.filter(o => !o.isDismissed);
            }
            
            document.getElementById('birthdayCount').textContent = displayBirthday.length;
            document.getElementById('regularCount').textContent = displayRegular.length;

            if (displayBirthday.length > 0) {
                birthdaySection.style.display = 'block';
                birthdayContainer.innerHTML = displayBirthday.map(offer => createOfferCard(offer, true)).join('');
            } else {
                birthdaySection.style.display = 'none';
            }

            if (displayRegular.length > 0) {
                regularSection.style.display = 'block';
                regularContainer.innerHTML = displayRegular.map(offer => createOfferCard(offer, false)).join('');
            } else {
                regularSection.style.display = 'none';
            }

            // Add click handlers
            document.querySelectorAll('.offer-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    // Don't toggle if clicking the button
                    if (!e.target.classList.contains('mark-used-btn') && !e.target.classList.contains('dismiss-btn')) {
                        this.classList.toggle('expanded');
                    }
                });
            });

            // Add mark as used button handlers
            document.querySelectorAll('.mark-used-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const offerId = this.dataset.offerId;
                    const card = this.closest('.offer-card');
                    
                    if (this.classList.contains('marked')) {
                        // Unmark as used
                        unmarkOfferAsUsed(offerId);
                        this.textContent = '‚úì Mark as Used';
                        this.classList.remove('marked');
                        card.classList.remove('used');
                        
                        // Update the offer in allOffersData
                        const offer = allOffersData.find(o => o.id === offerId);
                        if (offer) offer.isUsed = false;
                    } else {
                        // Mark as used
                        markOfferAsUsed(offerId);
                        this.textContent = '‚úì Marked as Used';
                        this.classList.add('marked');
                        card.classList.add('used');
                        
                        // Update the offer in allOffersData
                        const offer = allOffersData.find(o => o.id === offerId);
                        if (offer) offer.isUsed = true;
                    }
                    
                    // Refresh calendar if visible
                    if (document.getElementById('calendarView').style.display !== 'none') {
                        renderCalendar(currentCalendarDate);
                    }
                });
            });

            // Add dismiss button handlers
            document.querySelectorAll('.dismiss-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const offerId = this.dataset.offerId;
                    const card = this.closest('.offer-card');
                    
                    if (this.classList.contains('dismissed')) {
                        // Undismiss
                        undismissOffer(offerId);
                        this.textContent = 'üóëÔ∏è Dismiss';
                        this.classList.remove('dismissed');
                        card.classList.remove('dismissed');
                        
                        // Update the offer in allOffersData
                        const offer = allOffersData.find(o => o.id === offerId);
                        if (offer) offer.isDismissed = false;
                    } else {
                        // Dismiss
                        dismissOffer(offerId);
                        this.textContent = '‚Ü©Ô∏è Undismiss';
                        this.classList.add('dismissed');
                        card.classList.add('dismissed');
                        
                        // Update the offer in allOffersData
                        const offer = allOffersData.find(o => o.id === offerId);
                        if (offer) offer.isDismissed = true;
                    }
                    
                    // Refresh display if not showing dismissed
                    if (!showDismissedOffers) {
                        const birthdayOffers = allOffersData.filter(o => o.isBirthday);
                        const regularOffers = allOffersData.filter(o => !o.isBirthday);
                        displayOffers(birthdayOffers, regularOffers);
                    }
                    
                    // Refresh calendar if visible
                    if (document.getElementById('calendarView').style.display !== 'none') {
                        renderCalendar(currentCalendarDate);
                    }
                });
            });
        }

        function createOfferCard(offer, isBirthday) {
            const isUsed = offer.isUsed || false;
            const isDismissed = offer.isDismissed || false;
            const usedClass = isUsed ? 'used' : '';
            const dismissedClass = isDismissed ? 'dismissed' : '';
            const buttonText = isUsed ? '‚úì Marked as Used' : '‚úì Mark as Used';
            const buttonClass = isUsed ? 'marked' : '';
            
            // Check if offer is expired
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expires = new Date(offer.expiresDate);
            expires.setHours(0, 0, 0, 0);
            const isExpired = expires < today;
            
            const dismissText = isDismissed ? '‚Ü©Ô∏è Undismiss' : 'üóëÔ∏è Dismiss';
            const dismissBtnClass = isDismissed ? 'dismissed' : '';
            
            // Only show dismiss button for expired offers
            const dismissButton = isExpired ? `
                <button class="dismiss-btn ${dismissBtnClass}" data-offer-id="${offer.id}">
                    ${dismissText}
                </button>
            ` : '';
            
            return `
                <div class="offer-card ${isBirthday ? 'birthday' : ''} ${usedClass} ${dismissedClass}">
                    <div class="offer-header">
                        <div class="restaurant-name">${offer.restaurant}</div>
                        <div class="expires-badge ${getExpiryClass(offer.expiresDate)}">
                            ${offer.expiresText}
                        </div>
                    </div>
                    <div class="offer-preview">${offer.offer}</div>
                    <div class="offer-details">
                        <div class="detail-row">
                            <div class="detail-label">üìç Where:</div>
                            <div class="detail-value">${offer.location}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">üéÅ What:</div>
                            <div class="detail-value">${offer.offer}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">‚è∞ When:</div>
                            <div class="detail-value">Expires ${offer.expiresDate.toLocaleDateString()}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">üìß From:</div>
                            <div class="detail-value">${offer.emailDate.toLocaleDateString()}</div>
                        </div>
                        <button class="mark-used-btn ${buttonClass}" data-offer-id="${offer.id}">
                            ${buttonText}
                        </button>
                        ${dismissButton}
                    </div>
                </div>
            `;
        }

        function exportToCSV() {
            if (!allOffersData || allOffersData.length === 0) {
                alert('No offers to export. Please scan your emails first.');
                return;
            }

            // Create CSV header
            const headers = ['Restaurant', 'Offer', 'Birthday Offer', 'Expires', 'Location', 'Email Date'];
            
            // Create CSV rows
            const rows = allOffersData.map(offer => {
                return [
                    escapeCSV(offer.restaurant),
                    escapeCSV(offer.offer),
                    offer.isBirthday ? 'Yes' : 'No',
                    offer.expiresDate.toLocaleDateString(),
                    escapeCSV(offer.location),
                    offer.emailDate.toLocaleDateString()
                ];
            });

            // Combine header and rows
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `restaurant-offers-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function escapeCSV(text) {
            if (text === null || text === undefined) return '';
            text = String(text);
            // Escape quotes and wrap in quotes if contains comma, quote, or newline
            if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                return '"' + text.replace(/"/g, '""') + '"';
            }
            return text;
        }

        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // Set header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Get days from previous month
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Previous month days
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const dayNum = prevMonthLastDay - i;
                const dayCell = createCalendarDay(dayNum, new Date(year, month - 1, dayNum), true);
                grid.appendChild(dayCell);
            }
            
            // Current month days
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const isToday = currentDate.getTime() === today.getTime();
                const dayCell = createCalendarDay(day, currentDate, false, isToday);
                grid.appendChild(dayCell);
            }
            
            // Next month days to fill grid
            const totalCells = grid.children.length - 7; // Minus day headers
            const remainingCells = (Math.ceil(totalCells / 7) * 7) - totalCells;
            
            for (let day = 1; day <= remainingCells; day++) {
                const dayCell = createCalendarDay(day, new Date(year, month + 1, day), true);
                grid.appendChild(dayCell);
            }
        }

        function createCalendarDay(dayNum, date, otherMonth = false, isToday = false) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            if (otherMonth) dayCell.classList.add('other-month');
            if (isToday) dayCell.classList.add('today');
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = dayNum;
            dayCell.appendChild(dayNumber);
            
            // Find offers expiring on this date
            const dateStr = date.toDateString();
            let offersOnThisDay = allOffersData.filter(offer => {
                return offer.expiresDate.toDateString() === dateStr;
            });
            
            // Filter used offers if toggle is off
            if (!showUsedOffers) {
                offersOnThisDay = offersOnThisDay.filter(o => !o.isUsed);
            }
            
            // Filter dismissed offers if toggle is off
            if (!showDismissedOffers) {
                offersOnThisDay = offersOnThisDay.filter(o => !o.isDismissed);
            }
            
            if (offersOnThisDay.length > 0) {
                // Show up to 3 offers
                const displayOffers = offersOnThisDay.slice(0, 3);
                displayOffers.forEach(offer => {
                    const dot = document.createElement('div');
                    dot.className = 'calendar-offer-dot';
                    if (offer.isBirthday) dot.classList.add('birthday');
                    if (offer.isUsed) dot.classList.add('used');
                    dot.textContent = offer.restaurant;
                    dot.title = offer.offer + (offer.isUsed ? ' (Used)' : '');
                    dayCell.appendChild(dot);
                });
                
                // Show count if more than 3
                if (offersOnThisDay.length > 3) {
                    const countBadge = document.createElement('div');
                    countBadge.className = 'calendar-offer-count';
                    countBadge.textContent = `+${offersOnThisDay.length - 3}`;
                    dayCell.appendChild(countBadge);
                }
                
                // Add click handler to show all offers
                dayCell.style.cursor = 'pointer';
                dayCell.addEventListener('click', () => showOffersModal(date, offersOnThisDay));
            }
            
            return dayCell;
        }

        function showOffersModal(date, offers) {
            const modal = document.getElementById('offersModal');
            const modalDate = document.getElementById('modalDate');
            const modalOffers = document.getElementById('modalOffers');
            
            modalDate.textContent = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            modalOffers.innerHTML = offers.map(offer => createOfferCard(offer, offer.isBirthday)).join('');
            
            // Add click handlers for expanded cards
            modalOffers.querySelectorAll('.offer-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    // Don't toggle if clicking the button
                    if (!e.target.classList.contains('mark-used-btn') && !e.target.classList.contains('dismiss-btn')) {
                        this.classList.toggle('expanded');
                    }
                });
            });
            
            // Add mark as used button handlers
            modalOffers.querySelectorAll('.mark-used-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const offerId = this.dataset.offerId;
                    const card = this.closest('.offer-card');
                    
                    if (this.classList.contains('marked')) {
                        // Unmark as used
                        unmarkOfferAsUsed(offerId);
                        this.textContent = '‚úì Mark as Used';
                        this.classList.remove('marked');
                        card.classList.remove('used');
                        
                        // Update the offer in allOffersData
                        const offer = allOffersData.find(o => o.id === offerId);
                        if (offer) offer.isUsed = false;
                    } else {
                        // Mark as used
                        markOfferAsUsed(offerId);
                        this.textContent = '‚úì Marked as Used';
                        this.classList.add('marked');
                        card.classList.add('used');
                        
                        // Update the offer in allOffersData
                        const offer = allOffersData.find(o => o.id === offerId);
                        if (offer) offer.isUsed = true;
                    }
                    
                    // Refresh calendar
                    renderCalendar(currentCalendarDate);
                    
                    // Refresh list view if visible
                    if (document.getElementById('listView').style.display !== 'none') {
                        const birthdayOffers = allOffersData.filter(o => o.isBirthday);
                        const regularOffers = allOffersData.filter(o => !o.isBirthday);
                        displayOffers(birthdayOffers, regularOffers);
                    }
                });
            });
            
            // Add dismiss button handlers
            modalOffers.querySelectorAll('.dismiss-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const offerId = this.dataset.offerId;
                    const card = this.closest('.offer-card');
                    
                    if (this.classList.contains('dismissed')) {
                        // Undismiss
                        undismissOffer(offerId);
                        this.textContent = 'üóëÔ∏è Dismiss';
                        this.classList.remove('dismissed');
                        card.classList.remove('dismissed');
                        
                        // Update the offer in allOffersData
                        const offer = allOffersData.find(o => o.id === offerId);
                        if (offer) offer.isDismissed = false;
                    } else {
                        // Dismiss
                        dismissOffer(offerId);
                        this.textContent = '‚Ü©Ô∏è Undismiss';
                        this.classList.add('dismissed');
                        card.classList.add('dismissed');
                        
                        // Update the offer in allOffersData
                        const offer = allOffersData.find(o => o.id === offerId);
                        if (offer) offer.isDismissed = true;
                    }
                    
                    // Refresh calendar
                    renderCalendar(currentCalendarDate);
                    
                    // Refresh list view if visible and not showing dismissed
                    if (!showDismissedOffers && document.getElementById('listView').style.display !== 'none') {
                        const birthdayOffers = allOffersData.filter(o => o.isBirthday);
                        const regularOffers = allOffersData.filter(o => !o.isBirthday);
                        displayOffers(birthdayOffers, regularOffers);
                    }
                });
            });
            
            modal.classList.add('active');
        }
    </script>
</body>
</html>
