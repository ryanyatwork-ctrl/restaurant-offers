<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Food Offers Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .setup-screen {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .setup-screen h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
        }

        .setup-screen p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            color: #999;
            margin-top: 5px;
            font-size: 12px;
        }

        .help-link {
            color: #667eea;
            text-decoration: none;
            font-size: 13px;
        }

        .help-link:hover {
            text-decoration: underline;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            margin-top: 10px;
        }

        .connect-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .connect-btn:active {
            transform: scale(0.95);
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            color: white;
            text-align: center;
            margin: 15px 0;
            font-size: 14px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .offer-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .offer-card:active {
            transform: scale(0.98);
            background: #e9ecef;
        }

        .offer-card.birthday {
            border-left-color: #ff6b6b;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe3e3 100%);
        }

        .offer-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .restaurant-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            flex: 1;
        }

        .expires-badge {
            background: #ff6b6b;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            margin-left: 10px;
        }

        .expires-badge.soon {
            background: #ff6b6b;
        }

        .expires-badge.medium {
            background: #ffa500;
        }

        .expires-badge.later {
            background: #51cf66;
        }

        .offer-preview {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .offer-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 0;
        }

        .offer-card.expanded .offer-details {
            max-height: 500px;
            margin-top: 15px;
        }

        .detail-row {
            display: flex;
            padding: 10px 0;
            border-top: 1px solid #dee2e6;
        }

        .detail-label {
            font-weight: bold;
            color: #495057;
            width: 80px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #333;
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .count-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }

        .settings-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .settings-btn:active {
            background: rgba(255,255,255,0.3);
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box p {
            color: #1565c0;
            margin: 0;
            font-size: 13px;
        }

        #appContent {
            display: none;
        }

        .hidden {
            display: none;
        }

        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .view-toggle-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-toggle-btn.active {
            background: #667eea;
            color: white;
        }

        .view-toggle-btn:active {
            transform: scale(0.95);
        }

        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .calendar-nav-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav-btn:active {
            transform: scale(0.9);
        }

        .calendar-month-year {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            color: #667eea;
            padding: 10px 0;
            font-size: 12px;
        }

        .calendar-day {
            min-height: 80px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 5px;
            background: #fafafa;
            position: relative;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .calendar-day-number {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .calendar-offer-dot {
            width: 100%;
            background: #667eea;
            color: white;
            font-size: 9px;
            padding: 2px 3px;
            border-radius: 4px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .calendar-offer-dot.birthday {
            background: #ff6b6b;
        }

        .calendar-offer-dot:active {
            opacity: 0.8;
        }

        .calendar-offer-count {
            position: absolute;
            bottom: 3px;
            right: 3px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
        }

        .list-view {
            display: block;
        }

        .calendar-view {
            display: none;
        }

        .offers-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .offers-modal.active {
            display: flex;
        }

        .offers-modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            width: 100%;
        }

        .offers-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .offers-modal-close {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 600px) {
            .calendar-day {
                min-height: 60px;
                padding: 3px;
            }

            .calendar-offer-dot {
                font-size: 8px;
                padding: 1px 2px;
            }

            .calendar-day-number {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçî Food Offers Tracker</h1>
            <p>Never miss a restaurant deal!</p>
        </header>

        <!-- Setup Screen -->
        <div id="setupScreen" class="setup-screen">
            <h2>üîê One-Time Setup</h2>
            <p>Enter your Google API credentials below. These will be stored securely in your browser only.</p>
            
            <div class="info-box">
                <p><strong>Need credentials?</strong> Follow the setup guide to get your free Google API Key and Client ID from Google Cloud Console.</p>
            </div>

            <div class="form-group">
                <label for="clientId">Google Client ID</label>
                <input type="text" id="clientId" placeholder="xxxxx.apps.googleusercontent.com">
                <small>Looks like: 123456789-abc.apps.googleusercontent.com</small>
            </div>

            <div class="form-group">
                <label for="apiKey">Google API Key</label>
                <input type="text" id="apiKey" placeholder="AIzaSy...">
                <small>Starts with: AIzaSy</small>
            </div>

            <button id="saveCredentials" class="btn">Save & Continue</button>
            
            <p style="margin-top: 20px; text-align: center;">
                <a href="#" class="help-link" onclick="alert('1. Go to console.cloud.google.com\n2. Create new project\n3. Enable Gmail API\n4. Create API Key\n5. Create OAuth Client ID\n\nSee the full setup guide for detailed instructions!'); return false;">üìñ How do I get these credentials?</a>
            </p>
        </div>

        <!-- Main App Content -->
        <div id="appContent">
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="connectBtn" class="connect-btn">Connect Gmail</button>
                <button id="settingsBtn" class="settings-btn">‚öôÔ∏è Change Credentials</button>
                <div id="status" class="status"></div>
            </div>

            <!-- View Toggle -->
            <div id="viewToggle" class="view-toggle" style="display: none;">
                <button id="listViewBtn" class="view-toggle-btn active">üìã List View</button>
                <button id="calendarViewBtn" class="view-toggle-btn">üìÖ Calendar View</button>
            </div>

            <!-- List View (Original) -->
            <div id="listView" class="list-view">
                <div id="birthdaySection" class="section" style="display: none;">
                    <div class="section-header">
                        <span class="section-icon">üéÇ</span>
                        <span class="section-title">Birthday Offers</span>
                        <span id="birthdayCount" class="count-badge">0</span>
                    </div>
                    <div id="birthdayOffers"></div>
                </div>

                <div id="regularSection" class="section" style="display: none;">
                    <div class="section-header">
                        <span class="section-icon">üçΩÔ∏è</span>
                        <span class="section-title">All Offers</span>
                        <span id="regularCount" class="count-badge">0</span>
                    </div>
                    <div id="regularOffers"></div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendarView" class="calendar-view">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button id="prevMonth" class="calendar-nav-btn">‚Äπ</button>
                        <div class="calendar-month-year" id="calendarMonthYear"></div>
                        <button id="nextMonth" class="calendar-nav-btn">‚Ä∫</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <button id="refreshBtn" class="refresh-btn" style="display: none;">üîÑ Refresh Offers</button>
            <button id="exportBtn" class="refresh-btn" style="display: none; background: #51cf66; margin-top: 10px;">üì• Export to CSV</button>
        </div>

        <!-- Offers Modal for Calendar -->
        <div id="offersModal" class="offers-modal">
            <div class="offers-modal-content">
                <div class="offers-modal-header">
                    <h3 id="modalDate"></h3>
                    <button class="offers-modal-close" id="closeModal">√ó</button>
                </div>
                <div id="modalOffers"></div>
            </div>
        </div>
    </div>

    <script>
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let CLIENT_ID = '';
        let API_KEY = '';

        // Check if credentials exist on load
        window.addEventListener('load', function() {
            const savedClientId = localStorage.getItem('gmail_client_id');
            const savedApiKey = localStorage.getItem('gmail_api_key');

            if (savedClientId && savedApiKey) {
                CLIENT_ID = savedClientId;
                API_KEY = savedApiKey;
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('appContent').style.display = 'block';
                initializeAPIs();
            }
        });

        // Save credentials
        document.getElementById('saveCredentials').addEventListener('click', function() {
            const clientId = document.getElementById('clientId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!clientId || !apiKey) {
                alert('Please enter both Client ID and API Key');
                return;
            }

            if (!clientId.includes('.apps.googleusercontent.com')) {
                alert('Client ID should look like: xxxxx.apps.googleusercontent.com');
                return;
            }

            if (!apiKey.startsWith('AIzaSy')) {
                alert('API Key should start with: AIzaSy');
                return;
            }

            // Save to localStorage
            localStorage.setItem('gmail_client_id', clientId);
            localStorage.setItem('gmail_api_key', apiKey);

            CLIENT_ID = clientId;
            API_KEY = apiKey;

            // Show main app
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('appContent').style.display = 'block';

            // Initialize APIs
            initializeAPIs();
        });

        // Settings button to change credentials
        document.getElementById('settingsBtn').addEventListener('click', function() {
            if (confirm('Do you want to change your API credentials? This will require you to re-enter them.')) {
                localStorage.removeItem('gmail_client_id');
                localStorage.removeItem('gmail_api_key');
                document.getElementById('appContent').style.display = 'none';
                document.getElementById('setupScreen').classList.remove('hidden');
                document.getElementById('clientId').value = '';
                document.getElementById('apiKey').value = '';
            }
        });

        function initializeAPIs() {
            // Load Google API
            const script1 = document.createElement('script');
            script1.src = 'https://apis.google.com/js/api.js';
            script1.onload = gapiLoaded;
            document.body.appendChild(script1);

            const script2 = document.createElement('script');
            script2.src = 'https://accounts.google.com/gsi/client';
            script2.onload = gisLoaded;
            document.body.appendChild(script2);
        }

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
            });
            gapiInited = true;
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
        }

        document.getElementById('connectBtn').addEventListener('click', handleAuthClick);
        document.getElementById('refreshBtn').addEventListener('click', scanEmails);
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);

        let allOffersData = [];
        let currentCalendarDate = new Date();

        // View toggle
        document.getElementById('listViewBtn').addEventListener('click', function() {
            document.getElementById('listView').style.display = 'block';
            document.getElementById('calendarView').style.display = 'none';
            this.classList.add('active');
            document.getElementById('calendarViewBtn').classList.remove('active');
        });

        document.getElementById('calendarViewBtn').addEventListener('click', function() {
            document.getElementById('listView').style.display = 'none';
            document.getElementById('calendarView').style.display = 'block';
            this.classList.add('active');
            document.getElementById('listViewBtn').classList.remove('active');
            renderCalendar(currentCalendarDate);
        });

        // Calendar navigation
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar(currentCalendarDate);
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar(currentCalendarDate);
        });

        // Modal controls
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('offersModal').classList.remove('active');
        });

        document.getElementById('offersModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });

        function handleAuthClick() {
            if (!gapiInited || !gisInited) {
                alert('Please wait for Google APIs to load...');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('status').textContent = 'Connected! Scanning emails...';
                document.getElementById('connectBtn').disabled = true;
                await scanEmails();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function scanEmails() {
            try {
                document.getElementById('status').textContent = 'Scanning your emails...';
                
                // Search for food-related emails from the past year
                const queries = [
                    'subject:(offer OR deal OR coupon OR discount OR free) (restaurant OR food OR dining OR pizza OR burger OR cafe OR coffee)',
                    'birthday (restaurant OR dining OR food OR free)',
                    'from:(doordash OR ubereats OR grubhub OR restaurant OR dine)',
                    'reward points (restaurant OR food OR dining)'
                ];

                let allOffers = [];
                
                for (let query of queries) {
                    const response = await gapi.client.gmail.users.messages.list({
                        userId: 'me',
                        q: query,
                        maxResults: 50
                    });

                    if (response.result.messages) {
                        for (let message of response.result.messages) {
                            const details = await gapi.client.gmail.users.messages.get({
                                userId: 'me',
                                id: message.id,
                                format: 'full'
                            });
                            
                            const offer = parseEmailForOffer(details.result);
                            if (offer) {
                                allOffers.push(offer);
                            }
                        }
                    }
                }

                // Remove duplicates based on restaurant name and offer
                allOffers = removeDuplicates(allOffers);
                
                // Store globally for CSV export
                allOffersData = allOffers;
                
                // Separate birthday offers
                const birthdayOffers = allOffers.filter(o => o.isBirthday);
                const regularOffers = allOffers.filter(o => !o.isBirthday);

                // Sort by expiration date
                birthdayOffers.sort((a, b) => a.expiresDate - b.expiresDate);
                regularOffers.sort((a, b) => a.expiresDate - b.expiresDate);

                displayOffers(birthdayOffers, regularOffers);
                
                document.getElementById('status').textContent = `Found ${allOffers.length} offers!`;
                document.getElementById('refreshBtn').style.display = 'block';
                document.getElementById('exportBtn').style.display = 'block';
                document.getElementById('viewToggle').style.display = 'flex';
                
                // Reset calendar to current month
                currentCalendarDate = new Date();
                renderCalendar(currentCalendarDate);
                
            } catch (err) {
                document.getElementById('status').textContent = 'Error scanning emails. Please try again.';
                console.error('Error:', err);
            }
        }

        function parseEmailForOffer(message) {
            const headers = message.payload.headers;
            const subject = headers.find(h => h.name === 'Subject')?.value || '';
            const from = headers.find(h => h.name === 'From')?.value || '';
            const date = new Date(parseInt(message.internalDate));
            
            // Get email body
            let body = '';
            if (message.payload.body.data) {
                body = atob(message.payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
            } else if (message.payload.parts) {
                for (let part of message.payload.parts) {
                    if (part.mimeType === 'text/plain' || part.mimeType === 'text/html') {
                        if (part.body.data) {
                            body += atob(part.body.data.replace(/-/g, '+').replace(/_/g, '/'));
                        }
                    }
                }
            }

            // Check if it's food-related
            const foodKeywords = ['restaurant', 'food', 'pizza', 'burger', 'coffee', 'dining', 'meal', 'cafe', 'eat', 'sushi', 'taco', 'sandwich', 'delivery'];
            const offerKeywords = ['offer', 'deal', 'coupon', 'discount', 'free', 'off', '%', 'save', 'reward', 'promo'];
            
            const text = (subject + ' ' + body + ' ' + from).toLowerCase();
            
            const hasFood = foodKeywords.some(k => text.includes(k));
            const hasOffer = offerKeywords.some(k => text.includes(k));
            
            if (!hasFood || !hasOffer) return null;

            // Extract restaurant name
            const restaurant = extractRestaurantName(from, subject, body);
            
            // Check if birthday offer
            const isBirthday = /birthday|b-day|bday/i.test(text);
            
            // Extract offer details
            const offer = extractOfferDetails(subject, body);
            
            // Extract expiration date
            const expiresDate = extractExpirationDate(body, date);
            
            // Extract location if available
            const location = extractLocation(body);

            return {
                restaurant,
                offer,
                isBirthday,
                expiresDate,
                expiresText: formatExpiration(expiresDate),
                location,
                emailDate: date,
                subject,
                messageId: message.id
            };
        }

        function extractRestaurantName(from, subject, body) {
            // Try to extract from "From" field
            const fromMatch = from.match(/^([^<@]+)/);
            if (fromMatch) {
                let name = fromMatch[1].trim();
                // Clean up common email prefixes
                name = name.replace(/^(info|no-reply|noreply|contact|support|team)\s*/i, '');
                if (name.length > 3) return name;
            }
            
            // Try to find brand names in subject or body
            const brandPattern = /\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,2})\s+(?:Restaurant|Cafe|Coffee|Pizza|Burger)/;
            const match = (subject + ' ' + body).match(brandPattern);
            if (match) return match[1];
            
            return fromMatch ? fromMatch[1].trim() : 'Restaurant Offer';
        }

        function extractOfferDetails(subject, body) {
            // Look for specific offers
            const patterns = [
                /(\d+%\s+off)/i,
                /(buy\s+one\s+get\s+one|bogo)/i,
                /(free\s+[a-z\s]+(?:with|when))/i,
                /(\$\d+\s+off)/i,
                /(free\s+delivery)/i,
                /(complimentary\s+[a-z\s]+)/i
            ];
            
            for (let pattern of patterns) {
                const match = (subject + ' ' + body).match(pattern);
                if (match) return match[1];
            }
            
            // Fallback to subject line
            return subject.substring(0, 60);
        }

        function extractExpirationDate(body, emailDate) {
            // Look for expiration patterns
            const patterns = [
                /expires?\s+(?:on\s+)?(\w+\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4})/i,
                /valid\s+(?:until|through)\s+(\w+\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4})/i,
                /(?:until|through)\s+(\d{1,2}\/\d{1,2}\/\d{2,4})/i,
                /expires?\s+(\d{1,2}\/\d{1,2}\/\d{2,4})/i
            ];
            
            for (let pattern of patterns) {
                const match = body.match(pattern);
                if (match) {
                    const dateStr = match[1];
                    const parsed = new Date(dateStr);
                    if (!isNaN(parsed.getTime())) {
                        return parsed;
                    }
                }
            }
            
            // Default: 30 days from email date
            const defaultExpiry = new Date(emailDate);
            defaultExpiry.setDate(defaultExpiry.getDate() + 30);
            return defaultExpiry;
        }

        function extractLocation(body) {
            // Simple location extraction (could be enhanced)
            const locationPattern = /(?:location|address|visit us):\s*([^\n]+)/i;
            const match = body.match(locationPattern);
            return match ? match[1].trim().substring(0, 100) : 'See email for details';
        }

        function formatExpiration(date) {
            const now = new Date();
            const diff = date - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days < 0) return 'Expired';
            if (days === 0) return 'Today';
            if (days === 1) return 'Tomorrow';
            if (days < 7) return `${days} days`;
            if (days < 30) return `${Math.floor(days / 7)} weeks`;
            return date.toLocaleDateString();
        }

        function getExpiryClass(date) {
            const now = new Date();
            const diff = date - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days < 7) return 'soon';
            if (days < 30) return 'medium';
            return 'later';
        }

        function removeDuplicates(offers) {
            const seen = new Set();
            return offers.filter(offer => {
                const key = `${offer.restaurant}-${offer.offer}`.toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        function displayOffers(birthdayOffers, regularOffers) {
            const birthdaySection = document.getElementById('birthdaySection');
            const regularSection = document.getElementById('regularSection');
            const birthdayContainer = document.getElementById('birthdayOffers');
            const regularContainer = document.getElementById('regularOffers');
            
            document.getElementById('birthdayCount').textContent = birthdayOffers.length;
            document.getElementById('regularCount').textContent = regularOffers.length;

            if (birthdayOffers.length > 0) {
                birthdaySection.style.display = 'block';
                birthdayContainer.innerHTML = birthdayOffers.map(offer => createOfferCard(offer, true)).join('');
            } else {
                birthdaySection.style.display = 'none';
            }

            if (regularOffers.length > 0) {
                regularSection.style.display = 'block';
                regularContainer.innerHTML = regularOffers.map(offer => createOfferCard(offer, false)).join('');
            } else {
                regularSection.style.display = 'none';
            }

            // Add click handlers
            document.querySelectorAll('.offer-card').forEach(card => {
                card.addEventListener('click', function() {
                    this.classList.toggle('expanded');
                });
            });
        }

        function createOfferCard(offer, isBirthday) {
            return `
                <div class="offer-card ${isBirthday ? 'birthday' : ''}">
                    <div class="offer-header">
                        <div class="restaurant-name">${offer.restaurant}</div>
                        <div class="expires-badge ${getExpiryClass(offer.expiresDate)}">
                            ${offer.expiresText}
                        </div>
                    </div>
                    <div class="offer-preview">${offer.offer}</div>
                    <div class="offer-details">
                        <div class="detail-row">
                            <div class="detail-label">üìç Where:</div>
                            <div class="detail-value">${offer.location}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">üéÅ What:</div>
                            <div class="detail-value">${offer.offer}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">‚è∞ When:</div>
                            <div class="detail-value">Expires ${offer.expiresDate.toLocaleDateString()}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">üìß From:</div>
                            <div class="detail-value">${offer.emailDate.toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function exportToCSV() {
            if (!allOffersData || allOffersData.length === 0) {
                alert('No offers to export. Please scan your emails first.');
                return;
            }

            // Create CSV header
            const headers = ['Restaurant', 'Offer', 'Birthday Offer', 'Expires', 'Location', 'Email Date'];
            
            // Create CSV rows
            const rows = allOffersData.map(offer => {
                return [
                    escapeCSV(offer.restaurant),
                    escapeCSV(offer.offer),
                    offer.isBirthday ? 'Yes' : 'No',
                    offer.expiresDate.toLocaleDateString(),
                    escapeCSV(offer.location),
                    offer.emailDate.toLocaleDateString()
                ];
            });

            // Combine header and rows
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `restaurant-offers-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function escapeCSV(text) {
            if (text === null || text === undefined) return '';
            text = String(text);
            // Escape quotes and wrap in quotes if contains comma, quote, or newline
            if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                return '"' + text.replace(/"/g, '""') + '"';
            }
            return text;
        }

        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // Set header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Get days from previous month
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Previous month days
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const dayNum = prevMonthLastDay - i;
                const dayCell = createCalendarDay(dayNum, new Date(year, month - 1, dayNum), true);
                grid.appendChild(dayCell);
            }
            
            // Current month days
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const isToday = currentDate.getTime() === today.getTime();
                const dayCell = createCalendarDay(day, currentDate, false, isToday);
                grid.appendChild(dayCell);
            }
            
            // Next month days to fill grid
            const totalCells = grid.children.length - 7; // Minus day headers
            const remainingCells = (Math.ceil(totalCells / 7) * 7) - totalCells;
            
            for (let day = 1; day <= remainingCells; day++) {
                const dayCell = createCalendarDay(day, new Date(year, month + 1, day), true);
                grid.appendChild(dayCell);
            }
        }

        function createCalendarDay(dayNum, date, otherMonth = false, isToday = false) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            if (otherMonth) dayCell.classList.add('other-month');
            if (isToday) dayCell.classList.add('today');
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = dayNum;
            dayCell.appendChild(dayNumber);
            
            // Find offers expiring on this date
            const dateStr = date.toDateString();
            const offersOnThisDay = allOffersData.filter(offer => {
                return offer.expiresDate.toDateString() === dateStr;
            });
            
            if (offersOnThisDay.length > 0) {
                // Show up to 3 offers
                const displayOffers = offersOnThisDay.slice(0, 3);
                displayOffers.forEach(offer => {
                    const dot = document.createElement('div');
                    dot.className = 'calendar-offer-dot';
                    if (offer.isBirthday) dot.classList.add('birthday');
                    dot.textContent = offer.restaurant;
                    dot.title = offer.offer;
                    dayCell.appendChild(dot);
                });
                
                // Show count if more than 3
                if (offersOnThisDay.length > 3) {
                    const countBadge = document.createElement('div');
                    countBadge.className = 'calendar-offer-count';
                    countBadge.textContent = `+${offersOnThisDay.length - 3}`;
                    dayCell.appendChild(countBadge);
                }
                
                // Add click handler to show all offers
                dayCell.style.cursor = 'pointer';
                dayCell.addEventListener('click', () => showOffersModal(date, offersOnThisDay));
            }
            
            return dayCell;
        }

        function showOffersModal(date, offers) {
            const modal = document.getElementById('offersModal');
            const modalDate = document.getElementById('modalDate');
            const modalOffers = document.getElementById('modalOffers');
            
            modalDate.textContent = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            modalOffers.innerHTML = offers.map(offer => createOfferCard(offer, offer.isBirthday)).join('');
            
            // Add click handlers for expanded cards
            modalOffers.querySelectorAll('.offer-card').forEach(card => {
                card.addEventListener('click', function() {
                    this.classList.toggle('expanded');
                });
            });
            
            modal.classList.add('active');
        }
    </script>
</body>
</html>
